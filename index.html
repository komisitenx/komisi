<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TENX SISTEM - Dashboard</title>

  <!-- Tailwind + Font -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js & Firebase -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .sidebar { width: 240px; transition: transform 0.3s ease; }
    .sidebar-hidden { transform: translateX(-100%); }
    .menu-item.active {
      background: rgba(255,255,255,0.12);
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(2,6,23,0.08);
    }
    table tbody tr:nth-child(even) { background-color: #f8fafc; }
    table tbody tr:hover { background-color: #f1f5f9; }
    .card { background: white; border-radius: 12px; box-shadow: 0 6px 18px rgba(15,23,42,0.06); }
    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      display: none; z-index: 30;
    }
    .overlay.active { display: block; }
  </style>
</head>
<body class="bg-gray-50">

  <!-- Login Page -->
  <div id="loginPage" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-sky-500 to-indigo-600">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-96">
      <h1 class="text-1xl font-extrabold mb-6 text-center text-sky-600">
        SEMANGAT GUYS LOGIN user@gmail.com/user123
      </h1>
      <input id="email" type="email" placeholder="Email" class="w-full mb-3 p-3 border rounded-lg focus:ring-2 focus:ring-sky-500 focus:outline-none">
      <input id="password" type="password" placeholder="Password" class="w-full mb-4 p-3 border rounded-lg focus:ring-2 focus:ring-sky-500 focus:outline-none">
      <button onclick="login()" class="w-full bg-sky-600 hover:bg-sky-700 text-white py-2.5 rounded-lg font-semibold transition">Login</button>
      <p id="loginError" class="text-red-500 text-sm mt-3 hidden text-center">Login gagal, cek email/password</p>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden h-screen flex relative">

    <!-- Overlay untuk mobile -->
    <div id="overlay" class="overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar bg-gradient-to-b from-sky-700 to-sky-500 text-white p-6 flex flex-col min-h-screen fixed md:static z-40 sidebar-hidden md:translate-x-0">
      <h2 class="text-2xl font-bold mb-8">TENX APPAREL</h2>

      <!-- Admin Menu -->
      <nav id="adminMenu" class="space-y-2 hidden">
        <div class="menu-item p-2 cursor-pointer hover:bg-white/10 rounded" onclick="showPage('gajiPage')">Gaji</div>
        <div class="menu-item p-2 cursor-pointer hover:bg-white/10 rounded" onclick="showPage('keuanganPage')">Keuangan</div>
        <div class="menu-item p-2 cursor-pointer hover:bg-white/10 rounded" onclick="showPage('rabPage')">RAB</div>
        <div class="menu-item p-2 cursor-pointer hover:bg-white/10 rounded" onclick="showPage('grafikPage')">Grafik</div>
      </nav>

      <!-- User Menu -->
      <nav id="userMenu" class="space-y-2 hidden">
        <div class="menu-item p-2 cursor-pointer hover:bg-white/10 rounded" onclick="showPage('gajiPage')">Gaji</div>
      </nav>

      <div class="mt-auto">
        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 w-full py-2 rounded-lg font-semibold">Logout</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-4 md:p-8 overflow-y-auto w-full md:ml-0 ml-0">

      <!-- Header dengan tombol hamburger -->
      <div class="flex items-center justify-between mb-6 md:hidden">
        <button onclick="toggleSidebar()" class="text-sky-700 text-2xl">☰</button>
        <h1 class="text-xl font-bold text-sky-700">Dashboard</h1>
      </div>

      <!-- Gaji Page -->
      <section id="gajiPage" class="hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-sky-700">Daftar Gaji</h2>
          <button id="exportBtn" onclick="exportGajiCSV()" class="hidden bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium">⬇ Export CSV</button>
        </div>

        <div id="adminGajiForm" class="mb-6 hidden flex flex-col md:flex-row gap-2">
          <input id="nama" placeholder="Nama" class="p-2 border rounded-lg flex-1">
          <input id="jumlah" type="number" placeholder="Jumlah" class="p-2 border rounded-lg md:w-28 w-full">
          <input id="bayaran" type="number" placeholder="Bayaran" class="p-2 border rounded-lg md:w-32 w-full">
          <button onclick="tambahGaji()" class="bg-sky-600 hover:bg-sky-700 text-white px-5 py-2 rounded-lg">Tambah</button>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full card overflow-hidden text-sm">
            <thead class="bg-sky-600 text-white">
              <tr>
                <th class="p-3 text-left">Nama</th>
                <th class="p-3">Jumlah</th>
                <th class="p-3">Bayaran</th>
                <th class="p-3">Total</th>
                <th class="p-3">Cashout</th>
                <th class="p-3">Sisa</th>
                <th class="p-3">Aksi</th>
              </tr>
            </thead>
            <tbody id="gajiTable"></tbody>
          </table>
        </div>
      </section>

      <!-- Keuangan Page -->
      <section id="keuanganPage" class="hidden">
        <h2 class="text-2xl font-bold mb-6 text-sky-700">Catatan Keuangan</h2>

        <div class="mb-6 flex flex-col md:flex-row gap-2">
          <select id="jenis" class="p-2 border rounded-lg">
            <option value="pemasukan">Pemasukan</option>
            <option value="pengeluaran">Pengeluaran</option>
          </select>
          <input id="nominal" type="number" placeholder="Nominal" class="p-2 border rounded-lg md:w-40 w-full">
          <input id="keterangan" placeholder="Keterangan" class="p-2 border rounded-lg flex-1">
          <button onclick="tambahKeuangan()" class="bg-sky-600 hover:bg-sky-700 text-white px-5 py-2 rounded-lg">Tambah</button>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full card overflow-hidden text-sm">
            <thead class="bg-sky-600 text-white">
              <tr>
                <th class="p-3">Jenis</th>
                <th class="p-3">Nominal</th>
                <th class="p-3">Keterangan</th>
                <th class="p-3">Tanggal</th>
                <th class="p-3">Aksi</th>
              </tr>
            </thead>
            <tbody id="keuanganTable"></tbody>
          </table>
        </div>
      </section>

      <!-- RAB Page -->
      <section id="rabPage" class="hidden">
        <h2 class="text-2xl font-bold mb-6 text-sky-700">Catatan RAB</h2>

        <div class="mb-6 flex flex-col md:flex-row gap-2">
          <input id="rencana" placeholder="Rencana" class="p-2 border rounded-lg flex-1">
          <input id="anggaran" type="number" placeholder="Anggaran" class="p-2 border rounded-lg md:w-40 w-full">
          <button onclick="tambahRAB()" class="bg-sky-600 hover:bg-sky-700 text-white px-5 py-2 rounded-lg">Tambah</button>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full card overflow-hidden text-sm">
            <thead class="bg-sky-600 text-white">
              <tr>
                <th class="p-3">Rencana</th>
                <th class="p-3">Anggaran</th>
                <th class="p-3">Tanggal</th>
                <th class="p-3">Aksi</th>
              </tr>
            </thead>
            <tbody id="rabTable"></tbody>
          </table>
        </div>
      </section>

      <!-- Grafik Page -->
      <section id="grafikPage" class="hidden">
        <h2 class="text-2xl font-bold mb-6 text-sky-700">Grafik Keuangan</h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="bg-green-100 p-5 rounded-xl shadow card">
            <h3 class="font-bold text-green-700">Total Pemasukan</h3>
            <p id="totalPemasukan" class="text-2xl font-extrabold"></p>
          </div>
          <div class="bg-red-100 p-5 rounded-xl shadow card">
            <h3 class="font-bold text-red-700">Total Pengeluaran</h3>
            <p id="totalPengeluaran" class="text-2xl font-extrabold"></p>
          </div>
          <div class="bg-blue-100 p-5 rounded-xl shadow card">
            <h3 class="font-bold text-blue-700">Saldo</h3>
            <p id="saldo" class="text-2xl font-extrabold"></p>
          </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg card">
          <canvas id="grafikCanvas" height="100"></canvas>
        </div>
      </section>
    </main>
  </div>

  <script>
    // === Sidebar Toggle (Mobile) ===
    function toggleSidebar(){
      const sidebar = document.getElementById("sidebar");
      const overlay = document.getElementById("overlay");
      sidebar.classList.toggle("sidebar-hidden");
      overlay.classList.toggle("active");
    }

    // === Firebase ===
    const firebaseConfig = {
      apiKey: "AIzaSyA2jBUihCiLq6FBWKuJKrpXZcUAAFm12b0",
      authDomain: "komisi-team-tenx.firebaseapp.com",
      databaseURL: "https://komisi-team-tenx-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "komisi-team-tenx",
      storageBucket: "komisi-team-tenx.firebasestorage.app",
      messagingSenderId: "129031363517",
      appId: "1:129031363517:web:fa1b92f0f064de835b50d4"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let role = null;
    let chart = null;

    function formatRupiah(angka){
      const n = Number(angka ?? 0);
      if (isNaN(n)) return "0";
      return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    // === Auth ===
    function login(){
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      auth.signInWithEmailAndPassword(email,password)
        .then(()=>{
          document.getElementById("loginPage").classList.add("hidden");
          document.getElementById("dashboard").classList.remove("hidden");
        })
        .catch(()=> document.getElementById("loginError").classList.remove("hidden"));
    }

    auth.onAuthStateChanged(user=>{
      if(user){
        if(user.email === "admin@gmail.com"){ 
          role = "admin";
          document.getElementById("adminMenu").classList.remove("hidden");
          document.getElementById("adminGajiForm").classList.remove("hidden");
          document.getElementById("exportBtn").classList.remove("hidden");
          loadGaji(true); loadKeuangan(); loadRAB();
        } else {
          role = "user";
          document.getElementById("userMenu").classList.remove("hidden");
          loadGaji(false);
        }
        showPage('gajiPage');
      }
    });

    function logout(){ auth.signOut(); location.reload(); }

    // === Page Switch ===
    function showPage(id){
      ['gajiPage','keuanganPage','rabPage','grafikPage'].forEach(p=>{
        document.getElementById(p).classList.add("hidden");
      });
      document.getElementById(id).classList.remove("hidden");
    }

    // === Gaji ===
    function tambahGaji(){
      const nama = document.getElementById("nama").value;
      const jumlah = parseInt(document.getElementById("jumlah").value);
      const bayaran = parseInt(document.getElementById("bayaran").value);
      const total = jumlah * bayaran;
      db.ref("gaji").push({ nama,jumlah,bayaran,total,cashout:0,sisa:total });
    }

    function cashoutGaji(id,item){
      const jumlah = parseInt(prompt("Cashout nominal:"));
      if(!isNaN(jumlah)){
        const cashout = (item.cashout||0)+jumlah;
        const sisa = item.total - cashout;
        db.ref("gaji/"+id).update({cashout,sisa});
      }
    }

    function editGaji(id,item){
      const nama = prompt("Nama:", item.nama);
      const jumlah = parseInt(prompt("Jumlah:", item.jumlah));
      const bayaran = parseInt(prompt("Bayaran:", item.bayaran));
      if(!isNaN(jumlah) && !isNaN(bayaran)){
        const total = jumlah*bayaran;
        const sisa = total - (item.cashout||0);
        db.ref("gaji/"+id).set({
          nama,jumlah,bayaran,total,
          cashout:(item.cashout||0),
          sisa
        });
      }
    }

    function hapusGaji(id){ db.ref("gaji/"+id).remove(); }

    function loadGaji(isAdmin){
      db.ref("gaji").on("value",snap=>{
        const tbody = document.getElementById("gajiTable");
        tbody.innerHTML="";
        snap.forEach(c=>{
          const item=c.val();
          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td class="p-3">${item.nama}</td>
            <td class="p-3">${item.jumlah}</td>
            <td class="p-3">Rp${formatRupiah(item.bayaran)}</td>
            <td class="p-3">Rp${formatRupiah(item.total)}</td>
            <td class="p-3">Rp${formatRupiah(item.cashout||0)}</td>
            <td class="p-3">Rp${formatRupiah(item.sisa)}</td>
            <td class="p-3">${isAdmin?`
              <button onclick='cashoutGaji("${c.key}",${JSON.stringify(item)})' class="text-green-600">Cashout</button>
              <button onclick='editGaji("${c.key}",${JSON.stringify(item)})' class="text-blue-600">Edit</button>
              <button onclick='hapusGaji("${c.key}")' class="text-red-600">Hapus</button>
            `:"-"}</td>`;
          tbody.appendChild(tr);
        });
      });
    }

    function exportGajiCSV(){
      db.ref("gaji").once("value",snap=>{
        let csv="Nama,Jumlah,Bayaran,Total,Cashout,Sisa\n";
        snap.forEach(c=>{
          const i=c.val();
          csv+=`${i.nama},${i.jumlah},${i.bayaran},${i.total},${i.cashout},${i.sisa}\n`;
        });
        const blob=new Blob([csv],{type:"text/csv"});
        const a=document.createElement("a");
        a.href=URL.createObjectURL(blob);
        a.download="gaji.csv"; a.click();
      });
    }

    // === Keuangan ===
    function tambahKeuangan(){
      const jenis=document.getElementById("jenis").value;
      const nominal=parseInt(document.getElementById("nominal").value);
      const keterangan=document.getElementById("keterangan").value;
      const tanggal=new Date().toLocaleString();
      db.ref("keuangan").push({jenis,nominal,keterangan,tanggal});
    }

    function hapusKeuangan(id){ db.ref("keuangan/"+id).remove(); }

    function loadKeuangan(){
      db.ref("keuangan").on("value",snap=>{
        const tbody=document.getElementById("keuanganTable");
        tbody.innerHTML="";
        let totalP=0,totalK=0;
        snap.forEach(c=>{
          const i=c.val();
          if(i.jenis==="pemasukan") totalP+=i.nominal; else totalK+=i.nominal;
          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td class="p-3">${i.jenis}</td>
            <td class="p-3">Rp${formatRupiah(i.nominal)}</td>
            <td class="p-3">${i.keterangan}</td>
            <td class="p-3">${i.tanggal}</td>
            <td class="p-3"><button onclick='hapusKeuangan("${c.key}")' class="text-red-600">Hapus</button></td>`;
          tbody.appendChild(tr);
        });
        updateGrafik(totalP,totalK);
      });
    }

    // === RAB ===
    function tambahRAB(){
      const rencana=document.getElementById("rencana").value;
      const anggaran=parseInt(document.getElementById("anggaran").value);
      const tanggal=new Date().toLocaleString();
      db.ref("rab").push({rencana,anggaran,tanggal});
    }
    function hapusRAB(id){ db.ref("rab/"+id).remove(); }
    function loadRAB(){
      db.ref("rab").on("value",snap=>{
        const tbody=document.getElementById("rabTable");
        tbody.innerHTML="";
        snap.forEach(c=>{
          const i=c.val();
          const tr=document.createElement("tr");
          tr.innerHTML=`
            <td class="p-3">${i.rencana}</td>
            <td class="p-3">Rp${formatRupiah(i.anggaran)}</td>
            <td class="p-3">${i.tanggal}</td>
            <td class="p-3"><button onclick='hapusRAB("${c.key}")' class="text-red-600">Hapus</button></td>`;
          tbody.appendChild(tr);
        });
      });
    }

    // === Grafik ===
    function updateGrafik(totalP,totalK){
      document.getElementById("totalPemasukan").innerText="Rp"+formatRupiah(totalP);
      document.getElementById("totalPengeluaran").innerText="Rp"+formatRupiah(totalK);
      document.getElementById("saldo").innerText="Rp"+formatRupiah(totalP-totalK);

      const ctx=document.getElementById("grafikCanvas").getContext("2d");
      if(chart) chart.destroy();
      chart=new Chart(ctx,{
        type:"bar",
        data:{
          labels:["Pemasukan","Pengeluaran"],
          datasets:[{
            label:"Keuangan",
            data:[totalP,totalK],
            backgroundColor:["#22c55e","#ef4444"]
          }]
        },
        options:{responsive:true,maintainAspectRatio:false}
      });
    }
  </script>
</body>
</html>
